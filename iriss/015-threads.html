<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Threads - IRISS Scripts</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-408a80f7.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-f6e09bda.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">IRISS Scripts</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="threads"><a class="header" href="#threads">Threads</a></h1>
<p>Threads allow us to build programs where parts of the program can run independently of one another.</p>
<p>Threads <em>can</em> (big emphasis on â€œcanâ€) help you make faster and more responsive programs.</p>
<p>For example:</p>
<ul>
<li>As a web developer, I would like the server framework Iâ€™m using to start responding to the next request before itâ€™s finished responding to the previous request</li>
<li>As a game developer, I would like my game engine to capture player inputs without being blocked by the renderer</li>
<li>As a data engineer, I would like to process large sets of data with parallelism</li>
</ul>
<p>This series is accompanied by a free book, check the description for a link straight to this chapter.</p>
<p>My name is Daniel, welcome to IRISS.</p>
<h2 id="intro"><a class="header" href="#intro">Intro</a></h2>
<p>Weâ€™re going to step through:</p>
<ol>
<li>how we can run code in a thread, including sending data before it starts</li>
<li>how we can wait for a thread to end, including receiving data when it ends</li>
<li>how we can communicate with running threads</li>
<li>and how we can share state between threads</li>
</ol>
<p>Weâ€™ll also be touching again on our marker traits Send and Sync</p>
<h2 id="what-is-a-thread"><a class="header" href="#what-is-a-thread">What is a thread?</a></h2>
<p>Before we get into the Rust, itâ€™s worth discussing what a thread actually is.</p>
<p>When you run a program, that specific instance of the program is called a Process.</p>
<p>The process incorporates not just the instructions to be run but is an abstraction around various resources that the program has access to, such as memory.</p>
<p>You can run multiple processes which the operating system will schedule separately which could allow you to do more things at once, however, those processes wonâ€™t (or at least, shouldnâ€™t) have access to the same memory.</p>
<p>There are ways to communicate between processes, but they can be slower and more restrictive than if we could share memory.</p>
<p>The specific part of the Process responsible for executing your code is called a thread, and a single process will always have at least one thread but can have many.</p>
<p>Threads are scheduled by the operating system independently, allowing one process to do multiple things effectively concurrently.</p>
<h2 id="starting-a-thread"><a class="header" href="#starting-a-thread">Starting a thread</a></h2>
<p><img src="015-threads/01-thread-main.png" alt="01-thread-main.png"></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» Your program always has at least one thread, even your basic hello-world program runs in a thread.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» What weâ€™re interested in today is how we start more threads.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» This is a process called Spawning.</p>
<p><img src="015-threads/02-thread-spawn.png" alt="02-thread-spawn.png"></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» To spawn a thread, we use <code>std::thread::spawn</code>â€¦ but, this will do little on its own.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» If we run this code, can you see whatâ€™s missing in the output?</p>
<p><img src="015-threads/02-thread-spawn-output-nix.png" alt="02-thread-spawn-output-nix.png"></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» It looks like our thread didnâ€™t runâ€¦ but actually, its even worse than that.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» When writing this portion of the book, this is the output I consistently got from my Mac, and from Rust Playground.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» That consistency actually surprised me a little, but then when writing the script for this video on my Windows machineâ€¦</p>
<p><img src="015-threads/02-thread-spawn-output-win.png" alt="02-thread-spawn-output-win.png"></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» I got this.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» This is the inconsistency I was actually expecting, its not that our thread doesnâ€™t run, itâ€™s that it mightâ€¦ or it might not.</p>
<p><img src="015-threads/02-thread-spawn.png" alt="02-thread-spawn.png"></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» Spawning a thread returns a <code>JoinHandle</code>.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» The <code>JoinHandle</code> is what ties the spawned thread to the thread that spawned it.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» When the <code>JoinHandle</code> is dropped, which in this case happens instantly, the thread is orphaned.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» It may still run but, in this case, the process ends at the end of main, so whether the child thread runs or not, is no longer up to us.</p>
<p><img src="015-threads/03-thread-join.png" alt="03-thread-join.png"></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» We can tell our main thread to pause and wait for a running thread to end by calling <code>join</code> on the <code>JoinHandle</code>.</p>
<p><img src="015-threads/04-thread-join-fn.png" alt="04-thread-join-fn.png"></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» Weâ€™ve been using closures, but functions work just as well and can be better for more complex programs.</p>
<p><img src="015-threads/spawn-doc.png" alt="spawn-doc.png"></p>
<p>ğŸ“• The only restrictions are:</p>
<p>ğŸ“• - the function needs to be â€œFnOnce returning T, Send and staticâ€</p>
<p>ğŸ“• - and T also needs to be â€œSend and staticâ€</p>
<p>Exactly <em>when</em> threads are allowed to execute code is controlled by a scheduler which we canâ€™t directly manage ourselves, but we can influence it.</p>
<p>Putting one thread to sleep can allow another thread to run.</p>
<p><img src="015-threads/05-thread-sans-sleep.png" alt="05-thread-sans-sleep.png"></p>
<p>ğŸ¦€ If we run this code as-is, youâ€™ll see the main thread runs to completion before the child thread starts</p>
<p><img src="015-threads/05-thread-sans-sleep-output.png" alt="05-thread-sans-sleep-output.png"></p>
<p>ğŸ¦€ If we put each thread to sleep after it writes to standard out, we can â€œencourageâ€ the scheduler to start work on the other thread if it isnâ€™t already.</p>
<p><img src="015-threads/06-thread-sleep.png" alt="06-thread-sleep.png"></p>
<p><img src="015-threads/06-thread-sleep-output.png" alt="06-thread-sleep-output.png"></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» Thereâ€™s two <em>very</em> important things I want you to note here though</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» Firstly, thread::sleep is <em>not</em> a timer, your thread may sleep for longer than you requested or not at all in certain situations.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» Secondly, the scheduler ultimately decides when code is run, so thereâ€™s no guarantee you will get this <em>exact</em> output, so bare that in mind if <em>when code runs</em> matters to you.</p>
<p>So now we can run threads, letâ€™s start looking at how to send data back and forth between them.</p>
<p>We can pass data into a thread before it starts so long as the data is <code>Send</code>.</p>
<p>We previously talked about this trait in the Traits video, but to recap, data is <code>Send</code> so long as it can be safely sent between threads.</p>
<p>This trait is automatically implemented for all types that can be <code>Send</code> (though it is also possible to opt out of it).</p>
<p><img src="015-threads/07-thread-move.png" alt="07-thread-move.png"></p>
<p><img src="015-threads/07-thread-move-output.png" alt="07-thread-move-output.png"></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» We can move data into the closure that will be sent to the thread using the <code>move</code> keyword.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» Here we move the entire data vector into the spawned thread.</p>
<p><img src="015-threads/08-thread-return.png" alt="08-thread-return.png"></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» You can also return data via the join handler.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» This means you could pass hard work to a thread and do other work, coming back to check on the thread at a later time.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» A little side note, if itâ€™s helpful, you can check if the thread is finished with <code>.is_finished()</code>.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» Here Iâ€™m using it to let the person running the program know weâ€™re still waiting on the thread to do its work, but the program is still running.</p>
<h2 id="sending-messages"><a class="header" href="#sending-messages">Sending messages</a></h2>
<p>Now we can start one thread, thereâ€™s no stopping us!</p>
<p>Modern schedulers can manage a <em>lot</em> of threads at once, however, so far, we can only send data between a child thread and the parent that started it before and after that thread runs, not during.</p>
<p>What if we want to communicate across multiple threads, or send data to a thread while its running?</p>
<p><img src="015-threads/channel-doc.png" alt="channel-doc.png"></p>
<p>ğŸ“• Multi-producer, single-consumer (MPSC) is a queue pattern that allows us to create channels with multiple <code>Sender</code>s that can send messages, and a single <code>Reciever</code> that can receive them.</p>
<p>ğŸ“• As per the name, Multi-producer, you can clone <code>Sender</code>s but each of those clones can only send to a single <code>Reciever</code>.</p>
<p>The <code>Sender</code> and <code>Receiver</code> types are <code>Send</code> meaning that you can create them in one thread and send them to another.</p>
<p><img src="015-threads/09-channel.png" alt="09-channel.png"></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» Letâ€™s create a bunch of threads and give each of them a <code>Sender</code> that points back to a single <code>Reciever</code></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» We move the sender into the closure being run in the map method of an iterator.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» Because the closure now owns it, we can clone it for each thread weâ€™re spawning</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» And <em>move</em> the cloned sender to the child thread.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» Weâ€™ll send the <code>Reciever</code> to a final thread that will collect the data from the other threads.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» Finally, weâ€™ll join all the threads with a sender, before we join the thread with the receiver.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» This is important because this is the first bit of code weâ€™ve produced that can cause a deadlock, where two or more threads get blocked by each other</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» If you forget to join the senders first, they wonâ€™t send their messages but will block the receiver thread here, so your program gets stuck.</p>
<p>For what its worth, thereâ€™s no built-in way to create a channel with multiple receivers (<code>Receiver</code> is not <code>Clone</code>), however, thereâ€™s nothing stopping you building your own type for that, or there are crates that support it like <a href="https://docs.rs/crossbeam/latest/crossbeam/">Crossbeam</a>.</p>
<h2 id="sharing-state"><a class="header" href="#sharing-state">Sharing State</a></h2>
<p>So now we can send messages across threads, but what if we need multiple threads to have access to the <em>same</em> data, maybe even able to edit that data.</p>
<p>To do this, we need to use types that implement the <code>Sync</code> trait.</p>
<p>Something is <code>Send</code> if it can be sent between threads, but doing this moves ownership from one thread to another.</p>
<p>Something is <code>Sync</code> if a reference to it can be sent between threads</p>
<p>i.e. <code>T</code> is <code>Sync</code> if a reference <code>T</code> is <code>Send</code>.</p>
<p>Most things are <code>Sync</code>, but we still have to abide the rules of references in that we can have as many immutable references to something as we like, but we can only have one mutable reference.</p>
<p>Furthermore, references cannot outlive the data they referenceâ€¦ which is a little harder to confirm with threads.</p>
<p>How do you know the thread referencing your data doesnâ€™t exist for longer than the data itâ€™s referenced?</p>
<p>One option is using scoped threads which we can create with <code>std::thread::scope</code>.</p>
<p><img src="015-threads/10-state-immutable-references.png" alt="10-state-immutable-references.png"></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» The scope function takes a closure with a single parameter that gives us the scope context.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» We can use the scope context to spawn threads.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» We donâ€™t need to keep track of <code>JoinHandle</code>s this time, all scoped threads are joined at the end of the scope closure.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» However, the spawn method on the scope context does still return a <code>JoinHandle</code> if you want to handle potential thread panics.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» The scope function blocks the thread that called it, until all the threads it started have been joined, so after that weâ€™re safe to modify the data again, which here would require a mutable reference.</p>
<p><img src="015-threads/11-state-mutable-references.png" alt="11-state-mutable-references.png"></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» You can also send mutable references across threads like this, but, bear in mind, only one thread can access the mutable reference, and it must end before we can access our data again.</p>
<pre class="playground"><code class="language-rust edition2024">use std::thread::scope;

fn main() {
    let mut data = String::from("This is owned by the main thread");

    scope(|s| {
        s.spawn(|| {
            data.push_str(" but can be modified by a child thread");
        });
    });

    assert_eq!(
        &amp;data,
        "This is owned by the main thread but can be modified by a child thread"
    );
}</code></pre>
<p>So we can share readable data across multiple threads with immutable references, or share writable data temporarily with a single thread, but what if we want to share read/write access to data across multiple threads.</p>
<p>Letâ€™s start by thinking why we canâ€™t do this with just references.</p>
<p>When weâ€™re using threads, multiple parts of our program <em>can</em> be executed at the same time.</p>
<hr>
<p>Imagine we have two threads that want to change the data, behind a reference, based on what is currently stored there, something simple like each thread wants to multiply a numeric value.</p>
<ol>
<li>Thread 1 reads the value from memory into a register</li>
<li>Thread 2 reads the value from memory into a register</li>
<li>Thread 1 multiplies the data and stores it back in memory</li>
<li>Thread 2 multiplies the data and stores it back in memory</li>
</ol>
<hr>
<p>In this situation, weâ€™ve lost the effect of Thread 1, which <em>could</em> be a bug.</p>
<p>Letâ€™s consider a more serious version of this.</p>
<p>Imagine the data rather than just being a single value, is an image stored in an array like structure, and youâ€™re applying multiple processes to the image at the same time.</p>
<p>This time, if one thread were to override anotherâ€™s work, we have a much more obvious problem.</p>
<hr>
<p>To get around this, we need to prevent two threads accessing the same piece of data at the same time.</p>
<p>There is a general software abstraction concept called a â€œmutexâ€ that makes access to data MUTually EXclusive.</p>
<p>Rust provides itâ€™s mutex through <code>std::sync::Mutex</code>.</p>
<p>Once you place data inside a Mutex, to access it again, you need to â€œlockâ€ the Mutex.</p>
<p><img src="015-threads/12-state-mutex.png" alt="12-state-mutex.png"></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» If the Mutex is already locked, then the thread currently trying to access the data needs to wait for the existing lock to be released.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» the lock method on a <code>Mutex</code> returns a <code>MutexGuard</code></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» When the MutexGuard goes out of scope, the lock is dropped, allowing other threads to use the Mutex</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» If a thread panics while holding a MutexGuard, this poisons the Mutex, so locking a Mutex returns a result.</p>
<p>However, thereâ€™s still a slight problem here.</p>
<p>Weâ€™re currently very dependent on using scoped threads because we need our references to point back to the owned data, but scoped threads arenâ€™t the norm.</p>
<p>In fact, most of the time you use threads in Rust, they will probably be abstracted behind some other framework (for example, a web server, a game engine, or data processing tools).</p>
<p>The problem, of course, is that we donâ€™t know when the owned data will go out of scope and no longer be accessible.</p>
<p>We can solve this problem using an Atomic Reference Count.</p>
<hr>
<p>We havenâ€™t discussed reference counting yet as itâ€™s usually fairly niche, however, reference counting allows you to share data around an application without needing to clone it and side stepping complex reference rules or lifetimes.</p>
<p>It works by moving the data you want to share onto the heap, and allowing access through a reference count type.</p>
<p>When you clone the reference count value, instead of the data being cloned, it modifies its internal count of how many clones currently exist.</p>
<p>Every time a reference count type goes out of scope, the count is decreased.</p>
<p>Once the count hits zero, there are no further references to the data and so it can be safely dropped.</p>
<hr>
<p>Now, if youâ€™ve paid attention as to why we need a Mutex for modifying data across threads, youâ€™ll see that using a normal reference count wonâ€™t work.</p>
<p>If the reference counter is cloned or dropped while also being cloned or dropped in another thread, you could end up with an inconsistent count of references, meaning data gets dropped at the wrong time.</p>
<p>This is why we need a special reference count type, <code>std::sync::Arc</code>, an Atomic Reference Count.</p>
<p>Atomic data types guarantee atomic changes.</p>
<p>Atomic changes are guaranteed to appear to be instantaneous to all external observers, meaning that two threads can change the value, but that these changes cannot overlap.</p>
<p><code>Arc</code> is a little slower than Rusts built in basic reference counting type <code>std::rc::Rc</code>, but prevents corruption across threads.</p>
<blockquote>
<p>Editors note: I donâ€™t think Iâ€™ve <em>ever</em> used <code>Rc</code>, but I use <code>Arc</code> all the time, so donâ€™t worry that we didnâ€™t cover it in this series.</p>
<p>If you need to pass data around a single thread, wrapped in its own container, itâ€™s there for you to use</p>
</blockquote>
<p><img src="015-threads/13-state-arc-mutex.png" alt="13-state-arc-mutex.png"></p>
<p>ğŸ¦€ğŸ‘¨ğŸ» So, armed with this knowledge, we can go back to unscoped threads!</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» Like earlier, we can clone the arc in the map method of the iterator, and move the cloned value to the thread.</p>
<p>ğŸ¦€ğŸ‘¨ğŸ» Arc also implements Deref for its internal type, so we can call lock on the Mutex from the Arc.</p>
<p>And thatâ€™s it!</p>
<p>Hopefully threads feel a lot more accessible now, but let me know in the comments if you have any questions or want to share tips, tricks, or things I missed with others.</p>
<h2 id="next-video"><a class="header" href="#next-video">Next Video</a></h2>
<p>Once again, a massive thank-you to my Patreons, your support has been amazing!</p>
<p>If you enjoyed the video, remember to like and subscribe!</p>
<p>Iâ€™ve changed the order of the last three videos; Async Rust is now going to be the final boss of IRISS, using a <em>lot</em> of what weâ€™ve already learned.</p>
<p>Instead of Async then, next video will be on macros, specifically <code>macro_rules!</code> which is a built-in tool that allows metaprogramming in Rust.</p>
<p>This is great to mitigate lots of repeated boilerplate code, can be used to create domain-specific languages (DSLs), and Iâ€™ll be showing off my specific recent use case.</p>
<p>I donâ€™t think Iâ€™ve mentioned it on the IRISS videos, but Iâ€™ve started streaming, here on Tuesdays, 7pm UK time.</p>
<p>Weâ€™re building a Job Tracking app, and the streamâ€™s chat has been filled with really wonderful people with amazing thoughts and ideas and encouragement, if that interests you do drop by and say hi!</p>
<p>So, whether on stream or in the macros IRISS video, Iâ€™ll see you next time.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../iriss/014-iterators.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../iriss/016-macros.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../iriss/014-iterators.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../iriss/016-macros.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->
        <script src="../scripts/enable-checkboxes-3ea146e3.js"></script>



    </div>
    </body>
</html>
