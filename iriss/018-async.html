<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Async - IRISS Scripts</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-ec9cbdc1.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-6fd8910a.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">IRISS Scripts</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="async-rust"><a class="header" href="#async-rust">Async Rust</a></h1>
<h3 id="open-1"><a class="header" href="#open-1">open 1</a></h3>
<p>Often, when we write code, we have to wait on certain â€œthings that take timeâ€ to happen.</p>
<p>â€œThings that take timeâ€ are usually things like IO, such as reading or writing to a disk, getting data from a database, downloading a file, and so on.</p>
<p>Sometimes â€œthings that take timeâ€ could just be computationally expensive, such as processing large amounts of data.</p>
<h3 id="open-2"><a class="header" href="#open-2">open 2</a></h3>
<p>Usually our programs are complex with multiple parts to them.</p>
<p>For example, applications often have a user interface, whether thatâ€™s via a terminal, a web page, or a full desktop GUI.</p>
<p>If our application has to do â€œthings that take timeâ€, we donâ€™t want other aspects (like the UI) to freeze up, unable to do anything while we wait.</p>
<p>Asynchronous programming is an implementation-independent way to structure our code so that we can continue to do work while waiting on other things.</p>
<h3 id="open-3"><a class="header" href="#open-3">open 3</a></h3>
<p>This series is accompanied by a free book, check the description for a link straight to this chapter.</p>
<p>My name is Daniel, welcome to IRISS.</p>
<h2 id="intro"><a class="header" href="#intro">Intro</a></h2>
<h3 id="intro-1"><a class="header" href="#intro-1">intro 1</a></h3>
<p>Asynchronous programming doesnâ€™t necessarily mean threads.</p>
<p>Some languages that support async programming donâ€™t even support multiple threads.</p>
<p>Under the hood, we might use threads, or we may depend on Operating System hooks, or even, for embedded programming, we might directly depend on hardware interrupts and exceptions.</p>
<h3 id="intro-2"><a class="header" href="#intro-2">intro 2</a></h3>
<p>In this video weâ€™re going to explore the modular design of async programming in Rust.</p>
<p>Our aim is to get a solid(ish) understanding of the concepts involved, even though, in the real world, youâ€™re likely to depend on others to design and build the more complex parts of the system.</p>
<h2 id="move-and-pin"><a class="header" href="#move-and-pin">Move and Pin</a></h2>
<h3 id="pin-1"><a class="header" href="#pin-1">pin 1</a></h3>
<p>Before we jump into the main part of the video, as ever, we once again need to talk about memory, specifically: moving and pinning.</p>
<p>All data in our running program exists somewhere in memory, whether itâ€™s the stack, the heap, or static memory.</p>
<p>That means that everything has a pointer address in memory.</p>
<h3 id="pin-2"><a class="header" href="#pin-2">pin 2</a></h3>
<p>When we pass a variable to another function, ownership of that variable â€œmovesâ€ to the other function.</p>
<p>When we add a variable to a <code>Vec</code> then ownership of that variable â€œmovesâ€ to the heap.</p>
<p>Any time data â€œmovesâ€ ownership, it also physically moves in memory.</p>
<h3 id="pin-3"><a class="header" href="#pin-3">pin 3</a></h3>
<p><img src="018-async/01-move-and-pin-move.png" alt="01-move-and-pin-move.png">
<img src="018-async/02-move-and-pin-move-output.png" alt="02-move-and-pin-move-output.png"></p>
<p>ğŸ¦€ We can see this in action with some simple code and some knowledge about pointers from our previous video.</p>
<p>ğŸ¦€ Weâ€™ll create a <code>String</code> type and give it to the variable <code>greet</code>.</p>
<p>ğŸ¦€ As we know from last time, the data we care about, in this case â€œHello, world!â€ will exist on the Heap.</p>
<p>ğŸ¦€ The variable <code>greet</code> contains some metadata about where our <code>String</code> is in the Heap, but <code>greet</code> is stored on the stack.</p>
<p>ğŸ¦€ We can get the pointer address to <code>greet</code> on the stack like this.</p>
<p>ğŸ¦€ Now lets move <code>greet</code> to another function, and get the new <code>greet</code>s pointer.</p>
<p>ğŸ¦€ When we run the program, we get two similar, but different addresses.</p>
<h3 id="pin-4"><a class="header" href="#pin-4">pin 4</a></h3>
<p>This is usually fine, but <em>occasionally</em> things might need to know where they themselves are in memory.</p>
<p>This is called self-referencing.</p>
<p>If something references itself, and we move it, where does that reference now point?</p>
<h3 id="pin-5"><a class="header" href="#pin-5">pin 5</a></h3>
<p><img src="018-async/03-move-and-pin-self-reference-struct.png" alt="03-move-and-pin-self-reference-struct.png"></p>
<p>ğŸ¦€ Letâ€™s create a completely ridiculous struct that contains some data and a pointer to that data.</p>
<p>ğŸ¦€ When we create the struct, weâ€™ll need to set the pointer to <code>None</code> because the constructor itself will move the data.</p>
<p>ğŸ¦€ Instead, weâ€™ll set the pointer via a method after itâ€™s been moved into place.</p>
<p>ğŸ¦€ Finally, weâ€™ll do the really stupid thing and dereference the pointer into the value.</p>
<p>ğŸ¦€ Letâ€™s not forget that safety comment!</p>
<p>ğŸ¦€ Thatâ€™s better.</p>
<h3 id="pin-6"><a class="header" href="#pin-6">pin 6</a></h3>
<p><img src="018-async/04-move-and-pin-self-reference-moved.png" alt="04-move-and-pin-self-reference-moved.png"></p>
<p><img src="018-async/05-move-and-pin-self-reference-moved-output.png" alt="05-move-and-pin-self-reference-moved-output.png"></p>
<p>ğŸ¦€ Letâ€™s write some code to instantiate our example structâ€¦ and get that pointer set up.</p>
<p>ğŸ¦€ When we read the value via the pointer, it, perhaps surprisingly, works as expected!</p>
<p>ğŸ¦€ We can also change the value directly, and the pointer correctly gives us that updated value.</p>
<p>ğŸ¦€ Now letâ€™s move ownership, and, yes, this is actually enough to do so.</p>
<p>ğŸ¦€ Weâ€™re technically moving it within the same stack frame, but this is a new variable even if it has the same name.</p>
<p>ğŸ¦€ Updating the value works, but reading it now gives us the old value.</p>
<p>ğŸ¦€ <code>pointer_to_value</code> is just a number pointing at a location in memory.</p>
<p>ğŸ¦€ We moved the data, but the pointer is still pointing at the old location.</p>
<h3 id="pin-7"><a class="header" href="#pin-7">pin 7</a></h3>
<p>Self-referential data is dangerousâ€¦ but it can also be useful in certain circumstances.</p>
<blockquote>
<p>Not in the example I just gave, but still.</p>
</blockquote>
<p>For this reason, some Generic types occasionally need to take it into consideration.</p>
<p>To keep ourselves safe, we can â€œpinâ€ arbitrary data to memory, preventing it from being moved.</p>
<h3 id="pin-10"><a class="header" href="#pin-10">pin 10</a></h3>
<p>We use the <code>Pin</code> type to express this behavior.</p>
<blockquote>
<p><code>Pin</code> used to confuse me, but I actually donâ€™t think itâ€™s doing anything remotely clever.</p>
</blockquote>
<p>The type itself is just a container for a mutable reference, so the <code>Pin</code> itself is safe to move around</p>
<p>Through the magic of the borrow checker, holding that single mutable reference is enough to lock the data in place.</p>
<p>Itâ€™s more like a guard or guarantee than anything magical.</p>
<h3 id="pin-11"><a class="header" href="#pin-11">pin 11</a></h3>
<p><img src="018-async/06-move-and-pin-self-reference-pinned.png" alt="06-move-and-pin-self-reference-pinned.png"></p>
<p>ğŸ¦€ We can pin our example from earlier using <code>Pin::new</code></p>
<blockquote>
<p>ğŸ¦€ You canâ€™t always use this, its kinda goofy, Iâ€™ll explain in a minute</p>
</blockquote>
<p>ğŸ¦€ We now canâ€™t modify the original struct or move it because <code>Pin</code> is holding the mutable reference.</p>
<p>ğŸ¦€ But we <em>can</em> modify the data via the <code>Pin</code> thanks to <code>Deref</code> and <code>DerefMut</code>.</p>
<p>ğŸ¦€ We can also move the <code>Pin</code> and, unlike our earlier example, this works because the <code>Pin</code> is just a reference.</p>
<h3 id="pin-12"><a class="header" href="#pin-12">pin 12</a></h3>
<p>ğŸ“• Thereâ€™s a lot to <code>Pin</code> so and if youâ€™re curious about it, the standard library documentation has a lot more information.</p>
<p>ğŸ“• For this video its enough to know that, in specific circumstances, like in modular asynchronous architecture where we donâ€™t necessarily control everything, we need to be certain data wonâ€™t move unexpectedly, and this is achieved through the <code>Pin</code> type.</p>
<h3 id="pin-13"><a class="header" href="#pin-13">pin 13</a></h3>
<p><code>Pin::new</code> only works with types that are <code>Unpin</code>, which is the automatically implemented marker trait for types thatâ€¦ donâ€™t need to be pinned.</p>
<blockquote>
<p>Told you it was goofy.</p>
</blockquote>
<p>For things that do need to be pinned you can use things like <code>Box::pin</code> and the <code>pin!</code> macro which have their utility but, cruciallyâ€¦</p>
<p>â€¦do move the data youâ€™re trying to prevent moving, so take care of your references!</p>
<h3 id="pin-14"><a class="header" href="#pin-14">pin 14</a></h3>
<p>That said, you would have to Box a pin if you want to return it doesnâ€™t the stack.</p>
<p>In our example this is fine so long as we set the pointer after moving it into the Pin.</p>
<h2 id="breaking-down-work"><a class="header" href="#breaking-down-work">Breaking Down Work</a></h2>
<h3 id="tasks-1"><a class="header" href="#tasks-1">tasks 1</a></h3>
<p>ğŸ¨ When we build software, we can compartmentalize different parts of our program into tasks.</p>
<p>ğŸ¨ Imagine we want to download two websites and compare the contents.</p>
<p>ğŸ¨ We download website A, then download website B, then compare the contents of the two sites.</p>
<p>ğŸ¨ However, now that weâ€™ve broken it down into tasks, we can see the tasks for getting the websites donâ€™t depend on each other and could be performed at the same time.</p>
<p>ğŸ¨ Asynchronous design allows us to reason about our code at the task level.</p>
<p>ğŸ¨ It doesnâ€™t specifically tell us how that work will get done, though.</p>
<h3 id="tasks-2"><a class="header" href="#tasks-2">tasks 2</a></h3>
<p>Different languages provide asynchronous utilities in different ways.</p>
<p>In C# the default way async tasks are run is using multiple threads in a thread pool.</p>
<p>Node.js is a single-threaded runtime, though, so async code uses operating system callbacks to let your program know when a task is complete.</p>
<h3 id="tasks-3"><a class="header" href="#tasks-3">tasks 3</a></h3>
<p>Importantly, in both languages, async code â€œjust worksâ€</p>
<p>You can start using it out of the box.</p>
<h3 id="tasks-4"><a class="header" href="#tasks-4">tasks 4</a></h3>
<p>Rust provides ways to structure asynchronous code but doesnâ€™t have a default way of making sure Asynchronous work is actually performed.</p>
<p>Arguably this makes async Rust harder to work with than other languages that support async fully out of the box.</p>
<p>However, this allows software engineers to choose the method of task execution that will work best for their application.</p>
<h3 id="tasks-5"><a class="header" href="#tasks-5">tasks 5</a></h3>
<p>Over the rest of the video weâ€™ll go over the Rust way of thinking about asynchronous tasks and create our own way of getting the work described by those tasks to run asynchronously.</p>
<h2 id="tasks-schedulers-futures-and-executors"><a class="header" href="#tasks-schedulers-futures-and-executors">Tasks, Schedulers, Futures, and Executors</a></h2>
<h3 id="concepts-1"><a class="header" href="#concepts-1">concepts 1</a></h3>
<p>Asynchronous architectures allow us to break our work up so that we can process different bits of that work while waiting on other bits.</p>
<p>As discussed, conceptually, we break the work into tasks and then have some sort of scheduler that decides which task gets run when.</p>
<h3 id="concepts-2"><a class="header" href="#concepts-2">concepts 2</a></h3>
<p>In Rust, we represent tasks with the <code>Future</code> trait, which can be applied to any type.</p>
<p>We manage task scheduling through what are usually called executors (or sometimes runtimes), which themselves use <code>Waker</code>s to decide when to run different tasks.</p>
<h3 id="concepts-3"><a class="header" href="#concepts-3">concepts 3</a></h3>
<p>This sounds complicated, but by the end of this video, youâ€™ll hopefully have a reasonable idea of how <code>Future</code>s, executors, and <code>Waker</code>s work together, and if you donâ€™tâ€¦ thatâ€™s actually ok.</p>
<h3 id="concepts-4"><a class="header" href="#concepts-4">concepts 4</a></h3>
<p>Most of the time you wonâ€™t need to write any of these things yourself, but having even a vague understanding of them will help you write better async code, as well as spot and fix common issues you might run across.</p>
<p>Letâ€™s get started by building up our understanding step by step.</p>
<h2 id="futures"><a class="header" href="#futures">Futures</a></h2>
<h3 id="futures-1"><a class="header" href="#futures-1">futures 1</a></h3>
<p><img src="018-async/07-future-trait.png" alt="07-future-trait.png"></p>
<p>ğŸ“• The <code>Future</code> trait represents a task that may or may not be complete.</p>
<p>ğŸ“• Something that will be completed in the future, but not necessarily now.</p>
<p>ğŸ“• It has an associated type, <code>Output</code> and a single method, <code>.poll()</code>.</p>
<p>ğŸ“• <code>Output</code> represents the type of the data eventually returned by the <code>Future</code>.</p>
<p>ğŸ“• Usually this type will actually be a <code>Result&lt;T, E&gt;</code> because if weâ€™re waiting on something happening, thereâ€™s a chance that it might not.</p>
<p>ğŸ“• The <code>.poll()</code> method is a lot more interesting though.</p>
<h3 id="futures-2-cont-image"><a class="header" href="#futures-2-cont-image">futures 2 (cont image)</a></h3>
<p>ğŸ“• Firstly, youâ€™ll notice that <code>self</code> is typed, which we havenâ€™t seen in this series before.</p>
<p>ğŸ“• In <code>Future</code>â€™s, <code>self</code> is a Pinned mutable reference to data of the type the <code>Future</code> is applied to.</p>
<p>ğŸ“• The reason for this is <em>where</em> the <code>Future</code> executes might change, but because you might want to apply a <code>Future</code> to a self-referential type, we need to know the data the <code>Future</code> represents wonâ€™t itself move.</p>
<h3 id="futures-3-cont-image"><a class="header" href="#futures-3-cont-image">futures 3 (cont image)</a></h3>
<p>ğŸ“• <code>.poll()</code> also takes a mutable reference to some sort of <code>Context</code> type.</p>
<p>ğŸ“• For now, the only thing <code>Context</code> contains is a <code>Waker</code> which weâ€™ll talk about later.</p>
<p>ğŸ“• The reason we donâ€™t pass the <code>Waker</code> directly though is that in the futureâ€¦ of <code>Future</code>sâ€¦ we might want to add more data to a <code>Context</code>.</p>
<h3 id="futures-4"><a class="header" href="#futures-4">futures 4</a></h3>
<p><img src="018-async/08-poll-enum.png" alt="08-poll-enum.png"></p>
<p>ğŸ¦€ Finally, the return type of the <code>.poll()</code> method is a <code>Poll</code> enum.</p>
<p>ğŸ¦€ The <code>.poll()</code> method should be called any time we want to make progress on a task.</p>
<p>ğŸ¦€ The return type tells us whether that call has resulted in an <code>Output</code>, represented by <code>Poll::Ready(Self::Output)</code>, or if the poll is not currently complete and needs to be called again, represented by <code>Poll::Pending</code>.</p>
<h3 id="futures-5"><a class="header" href="#futures-5">futures 5</a></h3>
<blockquote>
<p>Once a Future has returned Ready, you <em>shouldnâ€™t</em> call it again.</p>
<p>The official documentation explicitly says, calling poll after Ready may result in a panic.</p>
<p>We will be breaking this rule later, but weâ€™ll be very cautious when we do.</p>
</blockquote>
<h3 id="futures-6"><a class="header" href="#futures-6">futures 6</a></h3>
<p><img src="018-async/09-example-future.png" alt="09-example-future.png"></p>
<p>ğŸ¦€ Letâ€™s make our first Future then.</p>
<p>ğŸ¦€ We can apply the Future trait to anything, even a unit struct is fine.</p>
<p>ğŸ¦€ For now, our poll method will immediately return <code>Poll::Ready</code> with a static lifetime string slice reference.</p>
<h3 id="futures-7"><a class="header" href="#futures-7">futures 7</a></h3>
<p><img src="018-async/10-example-future-poll.png" alt="10-example-future-poll.png"></p>
<p>ğŸ¦€ Weâ€™ll instantiate our unit struct, and immediately pin it.</p>
<p>ğŸ¦€ Next weâ€™re going to create a context with a no-op <code>Waker</code>.</p>
<p>ğŸ¦€ Donâ€™t worry about this yet, the â€œnoopâ€ <code>Waker</code> doesnâ€™t do anything, and weâ€™re not even using the context in this example.</p>
<p>ğŸ¦€ Unlike some languages, in Rust, Futures donâ€™t do anything unless you call the <code>.poll()</code> method, so weâ€™ll do that and store the response</p>
<p>ğŸ¦€ We can then use a match to extract the output from the Poll enum</p>
<p>ğŸ¦€ Normally, <code>Future</code>s wonâ€™t be â€œreadyâ€ immediately, and will need to be polled again.</p>
<h3 id="futures-8"><a class="header" href="#futures-8">futures 8</a></h3>
<p><img src="018-async/11-fake-worker.png" alt="11-fake-worker.png"></p>
<p>ğŸ¦€ Letâ€™s create a <code>Future</code> that doesnâ€™t complete the first time you poll it, using a simple counter.</p>
<p>ğŸ¦€ Each time we call the <code>.poll()</code> method weâ€™ll check if weâ€™re at zero by dereferencing the pin.</p>
<p>ğŸ¦€ If itâ€™s zero, then weâ€™re ready.</p>
<p>ğŸ¦€ If itâ€™s not zero, we need to change the work remaining however, youâ€™ll notice that <code>self</code> is not mutable.</p>
<blockquote>
<p>ğŸ¦€ This is where things get a littleâ€¦ interesting.</p>
</blockquote>
<p>ğŸ¦€ How youâ€™ll manage mutability in a <code>Future</code> you write yourself might depend on whether the <code>Future</code> needed to be pinned or not.</p>
<p>ğŸ¦€ If it did, youâ€™ll have to work out some kind of interior mutability mechanism for yourself.</p>
<p>ğŸ¦€ If it didnâ€™t, then in all likelihood your type automatically implemented <code>Unpin</code>, which means you can safely(ish) take the mutable reference out of the Pin with <code>.get_mut</code>.</p>
<p>ğŸ¦€ This consumes the Pin but lets you mutate the data via the mutable reference.</p>
<p>ğŸ¦€ So here we can subtract from work remaining and return Poll::Pending</p>
<h3 id="futures-9"><a class="header" href="#futures-9">futures 9</a></h3>
<p><img src="018-async/12-fake-worker-poll.png" alt="12-fake-worker-poll.png"></p>
<p>ğŸ¦€ Once again weâ€™ll create our Future and pin it.</p>
<p>ğŸ¦€ Then weâ€™ll create a context that doesnâ€™t do anything.</p>
<p>ğŸ¦€ When we call the <code>.poll()</code> method it consumes the <code>Pin</code>, but we can get a copy of the <code>Pin</code> with <code>as_mut()</code>, so long as our Pin is mutable</p>
<blockquote>
<p>ğŸ¦€ Its a bit weird but easy enough to work with.</p>
</blockquote>
<p>ğŸ¦€ Now poll the future until the work is done.</p>
<h3 id="futures-10"><a class="header" href="#futures-10">futures 10</a></h3>
<p>So managing futures is just about repeatedly calling <code>.poll()</code> right?</p>
<p>Wellâ€¦ no, not quite.</p>
<h2 id="executors"><a class="header" href="#executors">Executors</a></h2>
<h3 id="executors-1"><a class="header" href="#executors-1">executors 1</a></h3>
<p><img src="018-async/13-loop-executor.png" alt="13-loop-executor.png"></p>
<p>ğŸ¦€ Letâ€™s create a simple executor that <em>will</em> just poll <code>Future</code>s until theyâ€™re <code>Ready</code>.</p>
<p>ğŸ¦€ This executor takes a single generic <code>Future</code> and loops over the poll method</p>
<p>ğŸ¦€ As I mentioned earlier, we can only use <code>Pin::new</code> if the thing weâ€™re pinning is <code>Unpin</code>.</p>
<p>ğŸ¦€ We could restrict our executor to only accept <code>Future</code>s that are also <code>Unpin</code>, but using the <code>pin!</code> macro will let us keep our generic interface simple and broad.</p>
<p>ğŸ¦€ Again, the <code>pin!</code> macro will cause the <code>Future</code> to move, but as long as no self-references have been formed yet, this should be fine.</p>
<p>ğŸ¦€ Weâ€™ll create our noop waker and context.</p>
<p>ğŸ¦€ Next, weâ€™ll repeatedly call <code>.poll()</code> on the future until we have an output, which we instantly return from the loop with break, and from the executor via the loop.</p>
<h3 id="executors-2"><a class="header" href="#executors-2">executors 2</a></h3>
<p><img src="018-async/14-loop-executor-with-counter.png" alt="14-loop-executor-with-counter.png"></p>
<p>ğŸ¦€ This is all we need but for demonstrative purposes, lets add a bit of code to show how many times we called <code>.poll()</code>.</p>
<p>ğŸ¦€ Weâ€™ll start the counter at one, and add to it each time we get a Poll::Pending to get an accurate number of times we called <code>.poll()</code>.</p>
<p>ğŸ¦€ Weâ€™ll capture output here and return it at the end.</p>
<h3 id="executors-3"><a class="header" href="#executors-3">executors 3</a></h3>
<p><img src="018-async/15-loop-executor-fake-worker.png" alt="15-loop-executor-fake-worker.png"></p>
<p><img src="018-async/15-loop-executor-fake-worker-output.png" alt="15-loop-executor-fake-worker-output.png"></p>
<p>ğŸ¦€ Passing our previous example in, this seems to work quite well.</p>
<p>ğŸ¦€ We called poll four times, once for each of the three fake â€œworkâ€œs we needed to do, and once to get that final <code>Poll::Ready</code>.</p>
<h3 id="executors-4"><a class="header" href="#executors-4">executors 4</a></h3>
<p><img src="018-async/16-timer.png" alt="16-timer.png"></p>
<p>ğŸ¦€ But <code>Future</code>s usually wait on things like IO or heavy compute tasks which wonâ€™t nicely finish after a set number of calls.</p>
<p>ğŸ¦€ Letâ€™s try mimicking that with a simple timer.</p>
<p>ğŸ¦€ Weâ€™ll store a <code>SystemTime</code> after which our timer is considered to have elapsed, and weâ€™ll get that by instantiating the timer with a duration and adding it to the current time.</p>
<p>ğŸ¦€ When calling the <code>.poll()</code> method for the future implementation, weâ€™ll simply compare the current system time to the time after which we want to end and return Ready or Pending as appropriate.</p>
<p>ğŸ¦€ Letâ€™s give it to our loop executor and run it.</p>
<p>ğŸ¦€ Woof.</p>
<h3 id="executors-5"><a class="header" href="#executors-5">executors 5</a></h3>
<p><img src="018-async/18-timer-output.png" alt="18-timer-output.png"></p>
<p>ğŸ¦€ Fifty <em>million</em> calls to the poll methodâ€¦ in one second.</p>
<p>ğŸ¦€ I guess this speaks to the speed of Rust, but, wow are we doing a lot of nothing real quick here.</p>
<p>ğŸ¦€ This work is going to take resources like compute time away from other tasks, so we really want to avoid this.</p>
<p>ğŸ¦€ Rather than us polling the <code>Future</code> over and over, if only there was a way for the <code>Future</code> to let us know when it was ready to be polled again.</p>
<h2 id="waking"><a class="header" href="#waking">Waking</a></h2>
<h3 id="waking-1"><a class="header" href="#waking-1">waking 1</a></h3>
<p><code>Waker</code> is a struct the <code>Future</code> can use to inform the executor itâ€™s ready to have its <code>.poll()</code> method called again.</p>
<p>Before we get to that, though, weâ€™re going to update our program to use threads for both tasks and scheduling.</p>
<p>Itâ€™s important to note, however, that threads are not a necessary element of asynchronous Rust.</p>
<p>There are other ways to achieve Waking, but for now, this is the approach weâ€™ll take.</p>
<h3 id="waking-2"><a class="header" href="#waking-2">waking 2</a></h3>
<p><img src="018-async/19-thread-timer.png" alt="19-thread-timer.png"></p>
<p>ğŸ¦€ First, letâ€™s update our timer to use Threads.</p>
<p>ğŸ¦€ This is a bit more complex, so weâ€™ll talk through each bit.</p>
<p>ğŸ¦€ This time, weâ€™ll capture the <code>Duration</code> and save it for later.</p>
<p>ğŸ¦€ Once we start the thread weâ€™ll store its join handler in here.</p>
<p>ğŸ¦€ We wonâ€™t actually join the thread in the traditional sense, so to be honest, Iâ€™m not sure if this is necessary, I just didnâ€™t like the idea of orphaning the thread.</p>
<p>ğŸ¦€ Next weâ€™re finally going to use the Waker.</p>
<p>ğŸ¦€ We need to store it, and access if mutably from both the executor thread and the thread weâ€™re creating, so into an Arc Mutex it goes.</p>
<p>ğŸ¦€ When we instantiate the ThreadTimer we wonâ€™t have a Waker yet, so weâ€™ll use the noop waker.</p>
<p>ğŸ¦€ This saves using an Option and is safe as we wonâ€™t start the timer until the first poll, at which point weâ€™re given a real Waker.</p>
<p>ğŸ¦€ Finally, to mitigate a potential race condition weâ€™re going to mark the Timer as complete, and again, this needs to be accessible from both threads, so this is also an Arc Mutex.</p>
<h3 id="waking-3"><a class="header" href="#waking-3">waking 3</a></h3>
<p><img src="018-async/20-thread-timer-future.png" alt="20-thread-timer-future.png"></p>
<p>ğŸ¦€ To implement the Future, first we need to access the Future mutably multiple times.</p>
<p>ğŸ¦€ We know itâ€™s <code>Unpin</code> so weâ€™re going to grab the mutable reference to the Timer out of the pin with <code>get_mut</code>.</p>
<p>ğŸ¦€ Next, we replace our <code>Waker</code> every time the <code>.poll()</code> method is called.</p>
<p>ğŸ¦€ Normally this will actually be the same <code>Waker</code> each time, but it is technically possible to move a <code>Future</code> from one executor to another, which might mean we need to use a different Waker.</p>
<p>ğŸ¦€ In the event weâ€™re given a different <code>Waker</code> weâ€™ll store it every time <code>.poll()</code> is called.</p>
<p>ğŸ¦€ <code>poll</code> will be called multiple times, so if we havenâ€™t started the thread yet, we should do that now.</p>
<p>ğŸ¦€ Weâ€™ll take a copy of the Duration and clone the Arcâ€™s for <code>waker</code> and <code>is_complete</code> so they can be moved into the thread.</p>
<p>ğŸ¦€ The thread itself will simply sleep itself for the duration, then set <code>is_complete</code> to true, then call the waker.</p>
<p>ğŸ¦€ Once the thread is set up, and on each subsequent call of <code>.poll()</code> weâ€™ll check if the Timer is complete and return the appropriate Poll variant.</p>
<h3 id="waking-4"><a class="header" href="#waking-4">waking 4</a></h3>
<p>ğŸ¦€ Some important notes here.</p>
<p>ğŸ¦€ First, Iâ€™ve used <code>.unwrap()</code> when getting the Mutex lock primarily to make this code easy to read but also because if either our inner or outer threads panic, the program is unrecoverable for reasons other than locking the mutex.</p>
<p>ğŸ¦€ Ideally you should at least use <code>.expect()</code>, or our Future could return a <code>Result</code> but weâ€™ll come to that later.</p>
<p>ğŸ¦€ Second, thread sleep is not remotely accurate.</p>
<p>ğŸ¦€ Itâ€™s guaranteed to sleep for at least as long as the duration, but might sleep for longerâ€¦ unless you give it a duration of Zero, in which case it might sleep, or it might not, depending on your system!</p>
<p>ğŸ¦€ Thirdly, thereâ€™s one more thing in this code that Iâ€™m hoping if you <em>already</em> use a lot of async in Rust, this has you cold sweatsâ€¦ donâ€™t worry, itâ€™s safe, but weâ€™ll cover it at the end of the video. <em>wink</em></p>
<h3 id="waking-5"><a class="header" href="#waking-5">waking 5</a></h3>
<p><img src="018-async/22-thread-timer-loop-executor-output.png" alt="22-thread-timer-loop-executor-output.png"></p>
<p>ğŸ¦€ Before we move on, lets test our new timer in our old loop executor.</p>
<p>ğŸ¦€ Now when we run itâ€¦ we hit <code>.poll()</code> 140 million times.</p>
<p>ğŸ¦€ Technically, I guess we start the timer a bit later (after calling <code>.poll()</code> and constructing a thread), but also our comparisons are a bit cheaper.</p>
<p>ğŸ¦€ Still, this is out of hand.</p>
<p>ğŸ¦€ Time to fix it once and for all.</p>
<h3 id="waking-6"><a class="header" href="#waking-6">waking 6</a></h3>
<p><img src="018-async/23-thread-waker.png" alt="23-thread-waker.png"></p>
<p>ğŸ¦€ First, we need a <code>Waker</code>.</p>
<p>ğŸ¦€ The <code>Waker</code> type itself is a concrete type, but when its created we can give it any type that implements the <code>Wake</code> trait.</p>
<p>ğŸ¦€ To stop the executor from polling unnecessarily, our plan is to simply pause the whole thread the executor is on; this is called â€œparkingâ€ the thread.</p>
<p>ğŸ¦€ This makes our <code>ThreadWaker</code> fairly straightforward.</p>
<p>ğŸ¦€ We can create it with the <code>current_thread()</code> static method in which it takes a note of whatever thread it was created on.</p>
<p>ğŸ¦€ We implement the <code>Wake</code> trait for it, and when we call <code>wake</code>, all we do is â€œunparkâ€ that thread.</p>
<p>ğŸ¦€ Parking and Unparking is akin to pausing and unpausing threads.</p>
<h3 id="waking-7"><a class="header" href="#waking-7">waking 7</a></h3>
<p><img src="018-async/24-block-thread-on.png" alt="24-block-thread-on.png">
<img src="018-async/25-block-thread-on-counter.png" alt="25-block-thread-on-counter.png"></p>
<p>ğŸ¦€ So, onto the executor.</p>
<p>ğŸ¦€ Weâ€™ve got the same signature as the loop executor, accepting any future and returning its output.</p>
<p>ğŸ¦€ Weâ€™ll also pin the future before anything else, just like the loop executor.</p>
<p>ğŸ¦€ Our first real difference then is we now actually care about the <code>Waker</code>.</p>
<p>ğŸ¦€ We can create a <code>Waker</code> â€œfromâ€ an <code>Arc</code> of any type that implements the <code>Wake</code> trait.</p>
<p>ğŸ¦€ By creating our <code>ThreadWaker</code> on the same thread as the executor, thatâ€™s the thread that gets saved for later.</p>
<p>ğŸ¦€ Weâ€™ll then make our context from that waker.</p>
<p>ğŸ¦€ Again, all we need now is a loop over the future.</p>
<p>ğŸ¦€ If itâ€™s ready, weâ€™ll break from the loop and return that value.</p>
<p>ğŸ¦€ If itâ€™s not ready, weâ€™ll park the thread.</p>
<p>ğŸ¦€ When our ThreadTimer calls the <code>Waker</code> it unparks the thread, resuming the loop and causing the future to be called again.</p>
<p>ğŸ¦€ It could mean the Future is ready to progress, in which case it will return Pending again, or it could be Ready.</p>
<p>ğŸ¦€ Again, this is all thatâ€™s needed, but to show the improvement weâ€™ve made, lets add the counter back in</p>
<h3 id="waking-8"><a class="header" href="#waking-8">waking 8</a></h3>
<p><img src="018-async/26-block-thread-on-thread-timer.png" alt="26-block-thread-on-thread-timer.png">
<img src="018-async/27-block-thread-on-thread-timer-output.png" alt="27-block-thread-on-thread-timer-output.png"></p>
<p>ğŸ¦€ When we run our ThreadTimer in our new block_thread_on exectutor, you can see that our code is much more efficient with our poll method only being called twice.</p>
<p>ğŸ¦€ Once to start progressing the future, and once more to complete the future after the <code>Waker</code> is called.</p>
<p>ğŸ¦€ This means the program spends most of its one(ish) second runtime asleep, leaving resources like the CPU free to use.</p>
<h2 id="async--await"><a class="header" href="#async--await">Async / Await</a></h2>
<h3 id="async-1"><a class="header" href="#async-1">async 1</a></h3>
<p>The whole point of asynchronous code architectures is that we break our code down into small tasks.</p>
<p>Implementing our own Futures is great for the very edge of our Rust code where weâ€™re waiting on some sort of I/O from outside our program, or something like a compute heavy task we control.</p>
<h3 id="async-2"><a class="header" href="#async-2">async 2</a></h3>
<p>Most of the time we wonâ€™t necessarily even be doing that, though, as there are lots of crates for dealing with common I/O tasks, like reading files, accessing databases, or downloading files.</p>
<p>Most of the time, we just need to glue those bits together.</p>
<p>This is where async/await comes in.</p>
<h3 id="async-3"><a class="header" href="#async-3">async 3</a></h3>
<p><img src="018-async/28-async.png" alt="28-async.png"></p>
<p>ğŸ¦€ We can make any function or any block of code a <code>Future</code> with the <code>async</code> keyword.</p>
<p>ğŸ¦€ When you write async in front of a code block, that code block will be evaluated as a <code>Future</code> with an <code>Output</code> type that matches that of the block.</p>
<p>ğŸ¦€ In this example, we simply instantiate and return a <code>String</code>, so the async code block is a <code>Future</code> where the Output type is a String.</p>
<p>ğŸ¦€ To use this <code>Future</code> we can pass it straight into our executor.</p>
<p>ğŸ¦€ When you write <code>async</code> in front of a function, then the <em>return</em> value of calling that function is a <code>Future</code> with an <code>Output</code> type that matches the return type of the function.</p>
<p>ğŸ¦€ This example also returns a <code>String</code> but because the function is async, instead of getting a <code>String</code> when we call the function we get a <code>Future</code> where the <code>Output</code> type is a <code>String</code>.</p>
<p>ğŸ¦€ In this case we need to call the <code>async</code> function to get the <code>Future</code> to pass into our executor.</p>
<h3 id="async-4"><a class="header" href="#async-4">async 4</a></h3>
<p><img src="018-async/29-await.png" alt="29-await.png"></p>
<p>ğŸ¦€ But async code blocks and functions do something a little bit special.</p>
<p>ğŸ¦€ They can work up to another future and then pause until that future is ready to continue by using the <code>.await</code> postfix on a <code>Future</code>.</p>
<p>ğŸ¦€ Whatâ€™s rather brilliant in async code, though, is that when waked? wokenâ€¦ the code resumes from where it got to.</p>
<p>ğŸ¦€ Furthermore, <code>.await</code> will automatically unwrap the <code>Poll</code> enum for you, giving you the <code>Poll::Ready</code> value.</p>
<p>ğŸ¦€ Because our Timerâ€™s donâ€™t return any values, letâ€™s have this async block called by another.</p>
<p>ğŸ¦€ When we run this code, we go into <code>future_that_uses_that_value</code> then into <code>future_with_value</code>, then into the <code>ThreadTimer</code>.</p>
<p>ğŸ¦€ The <code>Waker</code> from the executor is passed all the way into that future, and then the executor pauses until its told work can proceed.</p>
<p>ğŸ¦€ After we exit out of <code>future_with_value</code> we get the value.</p>
<p>ğŸ¦€ More importantly, because the value is considered to be instantly available after awaiting it, and because most of the time when waiting on something we have to assume that thing might failâ€¦ we arrive at the most sublime pairing of Rust syntax, <code>.await?</code>.</p>
<h3 id="async-5"><a class="header" href="#async-5">async 5</a></h3>
<p><img src="018-async/30-await-try.png" alt="30-await-try.png">
<img src="018-async/31-await-try-good.png" alt="31-await-try-good.png">
<img src="018-async/32-await-try-bad.png" alt="32-await-try-bad.png"></p>
<p>ğŸ¦€ Functions that can fail should return a <code>Result</code>.</p>
<p>ğŸ¦€ <code>Future</code>â€™s always return the <code>Poll</code> enum but <code>Future::Output</code> will <em>regularly</em> be a Result.</p>
<p>ğŸ¦€ Letâ€™s create a Future that could fail.</p>
<p>ğŸ¦€ This future will Return the time since the Linux Epoch, in secondsâ€¦</p>
<p>ğŸ¦€ â€¦but only if that time is divisible by two, otherwise weâ€™ll return an error.</p>
<p>ğŸ¦€ Then weâ€™ll call that function, from another async function, and here is the magic!</p>
<p>ğŸ¦€ <code>.await</code> gets the <code>Poll::Ready</code> value, which is a <code>Result</code>, and the question mark operator either unwraps the Ok variant or bubbles the Error variant.</p>
<p>ğŸ¦€ Weâ€™ll handle our error outside our async code.</p>
<p>ğŸ¦€ A successful run looks like thisâ€¦ and an unsuccessful one looks like this!</p>
<h3 id="async-6"><a class="header" href="#async-6">async 6</a></h3>
<p>This doesnâ€™t need to be the end of the chain either!</p>
<p>Imagine a Future that returns <code>Poll&lt;Result&lt;Vec&lt;T&gt;, E&gt;&gt;</code>, you could <code>.await?.into_iter().map(|t: T| /* do some work */)...</code> etc.</p>
<p>This is another one of those Rust features that make the language really sublime to use!</p>
<h3 id="async-7"><a class="header" href="#async-7">async 7</a></h3>
<p><img src="018-async/33-await-series.png" alt="33-await-series.png">
<img src="018-async/34-await-series-output.png" alt="34-await-series-output.png"></p>
<p>ğŸ¦€ Anyway, because the <code>.await</code> postfix works on any future, and async code will resume from where it left off, we can <code>.await</code> several futures one after the other</p>
<p>ğŸ¦€ <code>.await</code> essentially pauses the execution of the code until the ThreadTimer future is ready, then continues on from that point.</p>
<p>ğŸ¦€ So this code is amazing, right? â€¦ Right?</p>
<p>ğŸ¦€ No! This code is bad, actually, but the reason may not be immediately obvious.</p>
<p>ğŸ¦€ Letâ€™s time how long this takes using Instant.</p>
<p>ğŸ¦€ The total time taken to run the timers is 3 seconds, which makes sense right?</p>
<p>ğŸ¦€ We have a two-second timer and a one-second timer, combined, thatâ€™s three secondsâ€¦ but thatâ€™s the problemâ€¦</p>
<h2 id="join"><a class="header" href="#join">Join</a></h2>
<h3 id="join-1"><a class="header" href="#join-1">join 1</a></h3>
<p>The two timers in the previous examples are stand-ins for some arbitrary work and are completely independent of each other.</p>
<p>We should <strong>not</strong> be waiting for the first timer to complete before working on the second timer, that defeats the benefits of asynchronous programming.</p>
<h3 id="join-2"><a class="header" href="#join-2">join 2</a></h3>
<p>What would be more useful is if we do both bits of â€œworkâ€ at the same time.</p>
<p>To do that, we need both Futures to be polled at the same time.</p>
<p>This is often called â€œjoiningâ€.</p>
<h3 id="join-3"><a class="header" href="#join-3">join 3</a></h3>
<p><img src="018-async/35-join-struct.png" alt="35-join-struct.png"></p>
<p>ğŸ¦€ Here is a rough example of what a Join might look like.</p>
<p>ğŸ¦€ Iâ€™m not going to go too deep into this code, because most of the time youâ€™ll end up using someone elseâ€™s join code (heck, even the standard library has a proposed future join macro).</p>
<p>ğŸ¦€ If you really want to see all the code, itâ€™s in the online IRISS book.</p>
<p>ğŸ¦€ To gloss over it a little bit, the <code>CollapsableFuture</code> is a wrapper Future that I made that takes any other Future and stores the output after itâ€™s Ready so that it doesnâ€™t matter how many times you call <code>.poll()</code>â€¦ youâ€™ll see why in a moment.</p>
<p>ğŸ¦€ When we create a new <code>Join</code> we pass in two Futures of any type, then pass those to new <code>CollapsableFuture</code>s.</p>
<p>ğŸ¦€ If you need to wait three futures, make one of those two another Joinâ€¦ or use someone elseâ€™s better code.</p>
<h3 id="join-4"><a class="header" href="#join-4">join 4</a></h3>
<p><img src="018-async/36-join-future.png" alt="36-join-future.png"></p>
<p>ğŸ¦€ Letâ€™s implement <code>Future</code> for <code>Join</code>.</p>
<p>ğŸ¦€ For a Join with the generic types F1 and F2, our Output will be a tuple of F1::Output and F2::Output.</p>
<p>ğŸ¦€ When you poll <code>Join</code>, it polls the inner <code>Future</code>s.</p>
<p>ğŸ¦€ It does this every time, which you arenâ€™t supposed to do, which is why I made the <code>CollapsableFuture</code> to keep my Join code simple.</p>
<p>ğŸ¦€ Once both polls report Ready, then we extract the actual output from collapsable future and return Ready from the Join.</p>
<h3 id="join-5"><a class="header" href="#join-5">join 5</a></h3>
<p>Ideally, you wonâ€™t be writing inefficient Joinâ€™s like this one yourself.</p>
<p>Most async crates provide their own version of join, such as Tokioâ€™s <code>join!</code> macro, and Smolâ€™s <code>.zip()</code> function.</p>
<p>Even the Rust standard library has <code>std::future::join</code> which theyâ€™re trying to stabilize.</p>
<h2 id="over-in-the-real-world"><a class="header" href="#over-in-the-real-world">Over in the Real World</a></h2>
<h3 id="real-world-1"><a class="header" href="#real-world-1">real world 1</a></h3>
<p>Rust doesnâ€™t come with its own Executors, or much in the way of Future utilities (other than what weâ€™ve covered here).</p>
<p>This is because the implementation details can vary significantly depending on what youâ€™re doing.</p>
<p>For example, while here weâ€™ve used Threads, Threads arenâ€™t necessary, arenâ€™t always available, and arenâ€™t particularly efficient in some situations.</p>
<h3 id="real-world-2"><a class="header" href="#real-world-2">real world 2</a></h3>
<p>If youâ€™re working on an embedded microcontroller, for example, rather than parking and unparking threads, you might use interrupts and exceptions to wake futures.</p>
<p>If youâ€™re running code inside an operating system, it might be more efficient to wait on callbacks from the OS to know when to wake a given future.</p>
<h3 id="real-world-3"><a class="header" href="#real-world-3">real world 3</a></h3>
<p>Rather than writing your own executors, though, youâ€™ll find that other people have provided executors for common use cases such as those in the Tokio and Smol crates.</p>
<p>These crates also come with a lot of utility types, functions, and macros, including substantially more efficient and ergonomic ways to join futures.</p>
<p>They also usually have code for common futures such as working with the file system or network traffic asynchronously, either via libraries or optional crate features.</p>
<h3 id="real-world-4"><a class="header" href="#real-world-4">real world 4</a></h3>
<p>Beyond this there are also executor agnostic libraries that provide futures for more specific needs like reqwest which provides HTTP specific futures, or SQLX, sequel x, squelexâ€¦</p>
<p>which provides connectivity to a variety of different database flavors.</p>
<h3 id="real-world-5"><a class="header" href="#real-world-5">real world 5</a></h3>
<p>So, most of the time when you work with async Rust in the real world, you wonâ€™t need to write executors, and you wonâ€™t need to implement the Future trait yourself.</p>
<p>Youâ€™ll use third party libraries for futures at the outer bounds of your software, join futures with third party utilities, and youâ€™ll glue it all together with futures created with <code>async</code> blocks and functions.</p>
<h3 id="real-world-6"><a class="header" href="#real-world-6">real world 6</a></h3>
<p><img src="018-async/37-tokio.png" alt="37-tokio.png"></p>
<p>ğŸ¦€ Returning to our rather silly example from the very beginning of this video, your <code>async</code> code is less likely to look like what weâ€™ve seen so far and much more likely to look like this:</p>
<p>ğŸ¦€ Isnâ€™t it beautiful?!</p>
<p>ğŸ¦€ Sure itâ€™s simplistic, but thereâ€™s not a <code>Future</code> trait or <code>Pin</code> in sight, and thatâ€™s genuinely what async Rust programming is like in the real world 99% of the time!</p>
<p>ğŸ¦€ So why did I just try to explain all of this?</p>
<p>ğŸ¦€ Because my hope is that, when you understand whatâ€™s happening under the hood, it will help you make the best use of async and avoidâ€¦</p>
<h2 id="common-gotchas"><a class="header" href="#common-gotchas">Common Gotchas</a></h2>
<h3 id="gotchas-1"><a class="header" href="#gotchas-1">gotchas 1</a></h3>
<p>Other than forgetting you can and should poll as many futures together as possible, see the earlier section on Joining futures, there are two fairly common gotchaâ€™s in async code.</p>
<p>Luckily, theyâ€™re much easier to spot when you have a fair understanding of whatâ€™s going on underneath.</p>
<h3 id="gotchas-2"><a class="header" href="#gotchas-2">gotchas 2</a></h3>
<p>The first is blocking.</p>
<p>We used threads in our examples, but you may not end up using a threaded executor, and even when you do, some executors allow multiple futures to run on a single thread.</p>
<p>This means using any blocking code could prevent a thread from continuing until itâ€™s complete, which could impact the execution of some or all of your other futures.</p>
<h3 id="gotchas-3"><a class="header" href="#gotchas-3">gotchas 3</a></h3>
<p>This is an easier mistake to make than you might think.</p>
<p>For example, reading a file or TCP stream using the standard library will block your thread until the action is completed.</p>
<h3 id="gotchas-4"><a class="header" href="#gotchas-4">gotchas 4</a></h3>
<p>Worse still is <code>Mutex</code> which will block a thread until the lock becomes available.</p>
<p>If there are two futures on the same thread, and one has a MutexGuard when the other requests a lock, the second future will block the thread, preventing the first thread from dropping the MutexGuard.</p>
<p>This causes a bug called â€œDeadlockâ€.</p>
<h3 id="gotchas-5"><a class="header" href="#gotchas-5">gotchas 5</a></h3>
<blockquote>
<p>If you cleverly noticed that I used standard library Mutexes earlier, good catch!</p>
<p>Luckily, the specific way theyâ€™re being used is safe as the locks are guaranteed to be on different threads.</p>
</blockquote>
<h3 id="gotchas-6"><a class="header" href="#gotchas-6">gotchas 6</a></h3>
<p>Libraries like Tokio and Smol either come with (or provide separately) their own interpretations of typically blocking behaviors that use Futures instead.</p>
<h3 id="gotchas-7"><a class="header" href="#gotchas-7">gotchas 7</a></h3>
<p>The second gotcha is with borrowing and ownership.</p>
<p>As weâ€™ve seen, thereâ€™s complexity around Futures that requires Pinning to be a thing.</p>
<p>This is because a Future might be moved by its executor, and if it is, self-referential data would point at old (or worse, freed) memory.</p>
<p>But it can get even more complex than that.</p>
<h3 id="gotchas-8"><a class="header" href="#gotchas-8">gotchas 8</a></h3>
<p>Rusts ownership model means that the lifetime of a reference must be trackable to make sure it doesnâ€™t outlive its owned data.</p>
<p>This gets a lot more challenging with futures as the compiler needs to track references through deferred work.</p>
<p>Thinking even more carefully about owned data, references, and the memory and CPU tradeoffs of cloning data can make async code harder to reason about.</p>
<h3 id="gotchas-9"><a class="header" href="#gotchas-9">gotchas 9</a></h3>
<p>Itâ€™s worth remembering that, particularly for smaller projects, you donâ€™t <em>have</em> to use async if itâ€™s causing your code to be more complicated than it would otherwise be.</p>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<h3 id="summary-1"><a class="header" href="#summary-1">summary 1</a></h3>
<p>Hopefully, after this video, you have a bit more of an understanding about whatâ€™s going on when you use async in Rust.</p>
<p>There are a variety of crates that help provide utilities for async each in their own way, so before you choose executor crates and <code>Future</code> supporting libraries, itâ€™s worth reading crate documentation to understand the options available and the choices made.</p>
<h3 id="summary-2"><a class="header" href="#summary-2">summary 2</a></h3>
<p>This is the end Idiomatic Rust in Simple Steps.</p>
<p>While there are many more language features available to you, I hope Iâ€™ve left you in a strong place to continue your journey.</p>
<h3 id="summary-3"><a class="header" href="#summary-3">summary 3</a></h3>
<p>I think I want to do a follow-up video for IRISS covering what you should do next on your learning journey, but after that I think weâ€™re done with the series.</p>
<p>I have some ideas for where to take Fioâ€™s Quest, including some quick potentially language agnostic videos on software engineering patterns, but what about you?</p>
<h3 id="gotchas-4-1"><a class="header" href="#gotchas-4-1">gotchas 4</a></h3>
<p>What would you like to see from the channel next?</p>
<p>Leave a comment or join our discord.</p>
<h3 id="gotchas-5-1"><a class="header" href="#gotchas-5-1">gotchas 5</a></h3>
<p>If youâ€™ve enjoyed the series, then remember to like and subscribe.</p>
<p>My name is Daniel, and this has been IRISS. <em>wink</em></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../iriss/017-unsafe.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../iriss/019-what-next.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../iriss/017-unsafe.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../iriss/019-what-next.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
